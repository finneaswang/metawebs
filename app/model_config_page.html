<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ¨¡å‹é…ç½®ç®¡ç†</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(15,23,42,0.08);
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 32px;
        }
        h3 {
            margin-bottom: 12px;
            color: #111827;
        }
        .section {
            margin-bottom: 32px;
        }
        .token {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .token input {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        .token small {
            color: #6b7280;
        }
        .current-config, .history {
            background: #f9fafb;
            padding: 18px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 120px;
            resize: vertical;
        }
        button {
            background: #2563eb;
            color: white;
            padding: 11px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: background 0.15s ease;
        }
        button:hover {
            background: #1d4ed8;
        }
        button[disabled] {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        .status.success {
            display: block;
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status.info {
            display: block;
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .config-item {
            margin-bottom: 8px;
        }
        .config-label {
            font-weight: 600;
            color: #374151;
            display: inline-block;
            width: 96px;
        }
        .config-value {
            color: #4b5563;
        }
        .muted {
            color: #9ca3af;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            margin-bottom: 12px;
            background: white;
        }
        .history-item.active {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37,99,235,0.15);
        }
        .history-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .history-meta {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 6px;
        }
        .history-detail {
            font-size: 13px;
            color: #4b5563;
        }
        .history-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .history-actions button {
            padding: 5px 10px;
            font-size: 13px;
        }
        .history-actions button.publish {
            background: #10b981;
        }
        .history-actions button.publish:hover {
            background: #059669;
        }
        .history-actions button.active {
            background: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="padding: 50px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            <h2>ğŸ¤– AIæ¨¡å‹é…ç½®ç®¡ç†</h2>
            <p>é¡µé¢åŠ è½½ä¸­...</p>
            <div style="margin: 20px 0;">
                <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const ModelConfigPage = () => {
            const [adminToken, setAdminToken] = useState('');
            const [currentConfig, setCurrentConfig] = useState(null);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            
            // å¯¹è¯æµ‹è¯•çŠ¶æ€
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [chatLoading, setChatLoading] = useState(false);
            const [testMode, setTestMode] = useState(false); // æ˜¯å¦ä½¿ç”¨æµ‹è¯•å‚æ•°

            // è¡¨å•çŠ¶æ€
            const [formData, setFormData] = useState({
                model: 'openai/gpt-4o-mini',
                temperature: 0.7,
                max_tokens: 1000,
                system_prompt: ''
            });

            // å¯ç”¨æ¨¡å‹åˆ—è¡¨
            const availableModels = [
                { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini', provider: 'OpenAI' },
                { id: 'openai/gpt-4o', name: 'GPT-4o', provider: 'OpenAI' },
                { id: 'anthropic/claude-3-haiku', name: 'Claude 3 Haiku', provider: 'Anthropic' },
                { id: 'anthropic/claude-3-sonnet', name: 'Claude 3 Sonnet', provider: 'Anthropic' },
                { id: 'mistralai/mistral-7b-instruct', name: 'Mistral 7B', provider: 'Mistral' },
                { id: 'google/gemini-pro', name: 'Gemini Pro', provider: 'Google' }
            ];

            // åŠ è½½å½“å‰é…ç½®
            const loadCurrentConfig = async () => {
                try {
                    const response = await fetch('/config/active');
                    if (response.ok) {
                        const config = await response.json();
                        setCurrentConfig(config);
                        if (config) {
                            setFormData({
                                model: config.model,
                                temperature: config.temperature,
                                max_tokens: config.max_tokens,
                                system_prompt: config.system_prompt || ''
                            });
                        }
                    }
                } catch (error) {
                    setMessage('åŠ è½½å½“å‰é…ç½®å¤±è´¥: ' + error.message);
                }
            };

            // åŠ è½½å†å²ç‰ˆæœ¬
            const loadHistory = async () => {
                try {
                    const response = await fetch('/config/history?limit=20');
                    if (response.ok) {
                        const data = await response.json();
                        setHistory(data);
                    }
                } catch (error) {
                    setMessage('åŠ è½½å†å²ç‰ˆæœ¬å¤±è´¥: ' + error.message);
                }
            };

            // ä¿å­˜æ–°é…ç½®
            const saveConfig = async () => {
                if (!adminToken) {
                    setMessage('è¯·å…ˆè¾“å…¥ç®¡ç†å‘˜å£ä»¤');
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch('/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-admin-token': adminToken
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        setMessage(`æ–°ç‰ˆæœ¬å·²ä¿å­˜: V${result.version} (ID: ${result.id})`);
                        loadHistory(); // åˆ·æ–°å†å²åˆ—è¡¨
                    } else {
                        const errorText = await response.text();
                        setMessage('ä¿å­˜å¤±è´¥: ' + errorText);
                    }
                } catch (error) {
                    setMessage('ä¿å­˜å¤±è´¥: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            // å‘å¸ƒé…ç½®
            const publishConfig = async (configId) => {
                if (!adminToken) {
                    setMessage('è¯·å…ˆè¾“å…¥ç®¡ç†å‘˜å£ä»¤');
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(`/config/${configId}/publish`, {
                        method: 'POST',
                        headers: {
                            'x-admin-token': adminToken
                        }
                    });

                    if (response.ok) {
                        setMessage('é…ç½®å‘å¸ƒæˆåŠŸï¼');
                        loadCurrentConfig(); // åˆ·æ–°å½“å‰é…ç½®
                        loadHistory(); // åˆ·æ–°å†å²åˆ—è¡¨
                    } else {
                        const errorText = await response.text();
                        setMessage('å‘å¸ƒå¤±è´¥: ' + errorText);
                    }
                } catch (error) {
                    setMessage('å‘å¸ƒå¤±è´¥: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            // å‘é€èŠå¤©æ¶ˆæ¯
            const sendChatMessage = async () => {
                if (!chatInput.trim()) return;
                
                const userMessage = chatInput.trim();
                setChatInput('');
                setChatLoading(true);
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
                setChatMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                
                try {
                    const chatConfig = testMode ? formData : null;
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            ...(chatConfig && {
                                model: chatConfig.model,
                                temperature: chatConfig.temperature,
                                max_tokens: chatConfig.max_tokens,
                                system_prompt: chatConfig.system_prompt
                            })
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        setChatMessages(prev => [...prev, { 
                            role: 'assistant', 
                            content: result.response,
                            config: result.config_used
                        }]);
                    } else {
                        const errorText = await response.text();
                        setChatMessages(prev => [...prev, { 
                            role: 'error', 
                            content: 'å‘é€å¤±è´¥: ' + errorText
                        }]);
                    }
                } catch (error) {
                    setChatMessages(prev => [...prev, { 
                        role: 'error', 
                        content: 'å‘é€å¤±è´¥: ' + error.message
                    }]);
                } finally {
                    setChatLoading(false);
                }
            };

            // æ¸…ç©ºèŠå¤©è®°å½•
            const clearChat = () => {
                setChatMessages([]);
            };

            // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
            useEffect(() => {
                loadCurrentConfig();
                loadHistory();
            }, []);

            return (
                <div className="container">
                    <h1>ğŸ¤– AIæ¨¡å‹é…ç½®ç®¡ç†</h1>

                    {/* ç®¡ç†å‘˜å£ä»¤ */}
                    <div className="section token">
                        <h3>ç®¡ç†å‘˜å£ä»¤</h3>
                        <input
                            type="password"
                            value={adminToken}
                            onChange={(e) => setAdminToken(e.target.value)}
                            placeholder="è¯·è¾“å…¥ x-admin-token"
                        />
                        <small>ä¿å­˜ã€å‘å¸ƒç­‰æ“ä½œä¼šåœ¨è¯·æ±‚å¤´ä¸­é™„å¸¦ x-admin-tokenã€‚</small>
                    </div>

                    {/* å½“å‰é…ç½®æ˜¾ç¤º */}
                    <div className="section current-config">
                        <h3>å½“å‰ç”Ÿæ•ˆé…ç½®</h3>
                        {currentConfig ? (
                            <div>
                                <div className="config-item">
                                    <span className="config-label">æ¨¡å‹:</span>
                                    <span className="config-value">{currentConfig.model}</span>
                                </div>
                                <div className="config-item">
                                    <span className="config-label">æ¸©åº¦:</span>
                                    <span className="config-value">{currentConfig.temperature}</span>
                                </div>
                                <div className="config-item">
                                    <span className="config-label">æœ€å¤§é•¿åº¦:</span>
                                    <span className="config-value">{currentConfig.max_tokens}</span>
                                </div>
                                <div className="config-item">
                                    <span className="config-label">ç³»ç»Ÿæç¤º:</span>
                                    <span className="config-value">{currentConfig.system_prompt || 'æ— '}</span>
                                </div>
                                <div className="config-item">
                                    <span className="config-label">æœ€åæ›´æ–°:</span>
                                    <span className="config-value">
                                        {new Date(currentConfig.created_at).toLocaleString('zh-CN')}
                                    </span>
                                </div>
                            </div>
                        ) : (
                            <p className="muted">å½“å‰æ²¡æœ‰ç”Ÿæ•ˆé…ç½®ï¼Œç³»ç»Ÿä¼šä½¿ç”¨é»˜è®¤å‚æ•°ã€‚</p>
                        )}
                    </div>

                    {/* é…ç½®è¡¨å• */}
                    <div className="section">
                        <h3>æ–°å»ºé…ç½®ç‰ˆæœ¬</h3>
                        
                        <div className="form-group">
                            <label>AIæ¨¡å‹:</label>
                            <select
                                value={formData.model}
                                onChange={(e) => setFormData({...formData, model: e.target.value})}
                            >
                                {availableModels.map(model => (
                                    <option key={model.id} value={model.id}>
                                        {model.name} ({model.provider})
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="form-group">
                            <label>åˆ›é€ æ€§ (Temperature): {formData.temperature}</label>
                            <input
                                type="range"
                                min="0"
                                max="1"
                                step="0.05"
                                value={formData.temperature}
                                onChange={(e) => setFormData({...formData, temperature: parseFloat(e.target.value)})}
                            />
                        </div>

                        <div className="form-group">
                            <label>æœ€å¤§å›å¤é•¿åº¦:</label>
                            <input
                                type="number"
                                min="100"
                                max="32768"
                                value={formData.max_tokens}
                                onChange={(e) => setFormData({...formData, max_tokens: parseInt(e.target.value)})}
                            />
                        </div>

                        <div className="form-group">
                            <label>ç³»ç»Ÿæç¤ºè¯ (å¯é€‰):</label>
                            <textarea
                                value={formData.system_prompt}
                                onChange={(e) => setFormData({...formData, system_prompt: e.target.value})}
                                placeholder="ä¾‹å¦‚: ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹..."
                            />
                        </div>

                        <button
                            onClick={saveConfig}
                            disabled={loading}
                        >
                            {loading ? 'ä¿å­˜ä¸­...' : 'ğŸ’¾ ä¿å­˜æ–°ç‰ˆæœ¬'}
                        </button>
                    </div>

                    {/* å¯¹è¯æµ‹è¯•åŒºåŸŸ */}
                    <div className="section">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3>ğŸ’¬ å¯¹è¯æµ‹è¯•</h3>
                            <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '5px', margin: 0 }}>
                                    <input
                                        type="checkbox"
                                        checked={testMode}
                                        onChange={(e) => setTestMode(e.target.checked)}
                                    />
                                    ä½¿ç”¨ä¸Šæ–¹æµ‹è¯•å‚æ•°
                                </label>
                                <button 
                                    onClick={clearChat}
                                    style={{ 
                                        background: '#6b7280', 
                                        padding: '5px 10px', 
                                        fontSize: '12px',
                                        minWidth: 'auto'
                                    }}
                                >
                                    æ¸…ç©ºå¯¹è¯
                                </button>
                            </div>
                        </div>
                        
                        {/* èŠå¤©è®°å½• */}
                        <div style={{ 
                            background: '#f9fafb',
                            border: '1px solid #e5e7eb',
                            borderRadius: '8px',
                            height: '400px',
                            overflowY: 'auto',
                            padding: '15px',
                            marginBottom: '15px'
                        }}>
                            {chatMessages.length === 0 ? (
                                <div style={{ 
                                    textAlign: 'center', 
                                    color: '#9ca3af', 
                                    marginTop: '150px' 
                                }}>
                                    å¼€å§‹ä¸AIå¯¹è¯æ¥æµ‹è¯•é…ç½®æ•ˆæœ...
                                </div>
                            ) : (
                                chatMessages.map((msg, index) => (
                                    <div key={index} style={{ marginBottom: '15px' }}>
                                        {msg.role === 'user' && (
                                            <div style={{ textAlign: 'right' }}>
                                                <div style={{
                                                    display: 'inline-block',
                                                    background: '#2563eb',
                                                    color: 'white',
                                                    padding: '10px 15px',
                                                    borderRadius: '18px',
                                                    maxWidth: '70%',
                                                    textAlign: 'left'
                                                }}>
                                                    {msg.content}
                                                </div>
                                            </div>
                                        )}
                                        {msg.role === 'assistant' && (
                                            <div>
                                                <div style={{
                                                    display: 'inline-block',
                                                    background: 'white',
                                                    border: '1px solid #e5e7eb',
                                                    padding: '10px 15px',
                                                    borderRadius: '18px',
                                                    maxWidth: '70%'
                                                }}>
                                                    {msg.content}
                                                </div>
                                                {msg.config && (
                                                    <div style={{ 
                                                        fontSize: '11px', 
                                                        color: '#6b7280', 
                                                        marginTop: '5px',
                                                        marginLeft: '15px'
                                                    }}>
                                                        {msg.config.model} | T:{msg.config.temperature} | Max:{msg.config.max_tokens}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        {msg.role === 'error' && (
                                            <div style={{
                                                background: '#fee2e2',
                                                color: '#991b1b',
                                                padding: '10px 15px',
                                                borderRadius: '8px',
                                                border: '1px solid #fecaca'
                                            }}>
                                                âŒ {msg.content}
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                            {chatLoading && (
                                <div style={{ textAlign: 'left' }}>
                                    <div style={{
                                        display: 'inline-block',
                                        background: 'white',
                                        border: '1px solid #e5e7eb',
                                        padding: '10px 15px',
                                        borderRadius: '18px',
                                        color: '#6b7280'
                                    }}>
                                        AIæ­£åœ¨æ€è€ƒä¸­...
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* è¾“å…¥åŒºåŸŸ */}
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <input
                                type="text"
                                value={chatInput}
                                onChange={(e) => setChatInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && !chatLoading && sendChatMessage()}
                                placeholder="è¾“å…¥æ¶ˆæ¯ä¸AIå¯¹è¯..."
                                style={{ flex: 1 }}
                                disabled={chatLoading}
                            />
                            <button
                                onClick={sendChatMessage}
                                disabled={chatLoading || !chatInput.trim()}
                                style={{ minWidth: '80px' }}
                            >
                                {chatLoading ? 'å‘é€ä¸­...' : 'å‘é€'}
                            </button>
                        </div>
                        
                        <div style={{ fontSize: '12px', color: '#6b7280', marginTop: '10px' }}>
                            ğŸ’¡ æç¤ºï¼šå‹¾é€‰"ä½¿ç”¨ä¸Šæ–¹æµ‹è¯•å‚æ•°"å¯ä»¥å®æ—¶æµ‹è¯•ä¸åŒé…ç½®çš„æ•ˆæœï¼Œä¸å‹¾é€‰åˆ™ä½¿ç”¨å½“å‰ç”Ÿæ•ˆé…ç½®
                        </div>
                    </div>

                    {/* å†å²ç‰ˆæœ¬ */}
                    <div className="section history">
                        <h3>å†å²ç‰ˆæœ¬</h3>
                        {history.length > 0 ? (
                            <div>
                                {history.map(item => (
                                    <div key={item.id} className={`history-item ${item.is_active ? 'active' : ''}`}>
                                        <div>
                                            <div className="history-title">
                                                ç‰ˆæœ¬ V{item.version} {item.is_active && '(å½“å‰ç”Ÿæ•ˆ)'}
                                            </div>
                                            <div className="history-meta">
                                                åˆ›å»ºæ—¶é—´: {new Date(item.created_at).toLocaleString('zh-CN')}
                                            </div>
                                            <div className="history-detail">
                                                æ¨¡å‹: {item.model} | æ¸©åº¦: {item.temperature} | é•¿åº¦: {item.max_tokens}
                                            </div>
                                        </div>
                                        <div className="history-actions">
                                            <button
                                                onClick={() => publishConfig(item.id)}
                                                disabled={item.is_active || loading}
                                                className={item.is_active ? 'active' : 'publish'}
                                            >
                                                {item.is_active ? 'å½“å‰ç”Ÿæ•ˆ' : 'å‘å¸ƒ'}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p className="muted">æš‚æ— å†å²ç‰ˆæœ¬</p>
                        )}
                    </div>

                    {/* çŠ¶æ€æ¶ˆæ¯ */}
                    {message && (
                        <div className={`status ${message.includes('æˆåŠŸ') ? 'success' : 'error'}`}>
                            {message}
                        </div>
                    )}
                </div>
            );
        };

        try {
            ReactDOM.render(<ModelConfigPage />, document.getElementById('root'));
        } catch (error) {
            console.error('Reactæ¸²æŸ“é”™è¯¯:', error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h2>é¡µé¢åŠ è½½å¤±è´¥</h2>
                    <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•</p>
                    <p style="color: red; font-size: 12px;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
