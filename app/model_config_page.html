<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÊ®°ÂûãÈÖçÁΩÆÁÆ°ÁêÜ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(15,23,42,0.08);
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 32px;
        }
        h3 {
            margin-bottom: 12px;
            color: #111827;
        }
        .section {
            margin-bottom: 32px;
        }
        .token {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .token input {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        .token small {
            color: #6b7280;
        }
        .current-config, .history {
            background: #f9fafb;
            padding: 18px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 120px;
            resize: vertical;
        }
        button {
            background: #2563eb;
            color: white;
            padding: 11px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: background 0.15s ease;
        }
        button:hover {
            background: #1d4ed8;
        }
        button[disabled] {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        .status.success {
            display: block;
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status.info {
            display: block;
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .config-item {
            margin-bottom: 8px;
        }
        .config-label {
            font-weight: 600;
            color: #374151;
            display: inline-block;
            width: 96px;
        }
        .config-value {
            color: #4b5563;
        }
        .muted {
            color: #9ca3af;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            margin-bottom: 12px;
            background: white;
        }
        .history-item.active {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37,99,235,0.15);
        }
        .history-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .history-meta {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 6px;
        }
        .history-detail {
            font-size: 13px;
            color: #4b5563;
        }
        .history-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .history-actions button {
            padding: 5px 10px;
            font-size: 13px;
        }
        .history-actions button.publish {
            background: #10b981;
        }
        .history-actions button.publish:hover {
            background: #059669;
        }
        .history-actions button.active {
            background: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="padding: 50px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            <h2>ü§ñ AIÊ®°ÂûãÈÖçÁΩÆÁÆ°ÁêÜ</h2>
            <p>È°µÈù¢Âä†ËΩΩ‰∏≠...</p>
            <div style="margin: 20px 0;">
                <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const ModelConfigPage = () => {
            const [adminToken, setAdminToken] = useState('');
            const [currentConfig, setCurrentConfig] = useState(null);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            
            // ÂØπËØùÊµãËØïÁä∂ÊÄÅ
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [chatLoading, setChatLoading] = useState(false);
            const [testMode, setTestMode] = useState(false); // ÊòØÂê¶‰ΩøÁî®ÊµãËØïÂèÇÊï∞

            // Ë°®ÂçïÁä∂ÊÄÅ
            const [formData, setFormData] = useState({
                model: 'openai/gpt-4o-mini',
                temperature: 0.7,
                max_tokens: 1000,
                system_prompt: ''
            });

            // ÂèØÁî®Ê®°ÂûãÂàóË°®
            const availableModels = [
                { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini', provider: 'OpenAI' },
                { id: 'openai/gpt-4o', name: 'GPT-4o', provider: 'OpenAI' },
                { id: 'anthropic/claude-3-haiku', name: 'Claude 3 Haiku', provider: 'Anthropic' },
                { id: 'anthropic/claude-3-sonnet', name: 'Claude 3 Sonnet', provider: 'Anthropic' },
                { id: 'mistralai/mistral-7b-instruct', name: 'Mistral 7B', provider: 'Mistral' },
                { id: 'google/gemini-pro', name: 'Gemini Pro', provider: 'Google' }
            ];

            // Âä†ËΩΩÂΩìÂâçÈÖçÁΩÆ
            const loadCurrentConfig = async () => {
                try {
                    const response = await fetch('/config/active');
                    if (response.ok) {
                        const config = await response.json();
                        setCurrentConfig(config);
                        if (config) {
                            setFormData({
                                model: config.model,
                                temperature: config.temperature,
                                max_tokens: config.max_tokens,
                                system_prompt: config.system_prompt || ''
                            });
                        }
                    }
                } catch (error) {
                    setMessage('Âä†ËΩΩÂΩìÂâçÈÖçÁΩÆÂ§±Ë¥•: ' + error.message);
                }
            };

            // Âä†ËΩΩÂéÜÂè≤ÁâàÊú¨
            const loadHistory = async () => {
                try {
                    const response = await fetch('/config/history?limit=20');
                    if (response.ok) {
                        const data = await response.json();
                        setHistory(data);
                    }
                } catch (error) {
                    setMessage('Âä†ËΩΩÂéÜÂè≤ÁâàÊú¨Â§±Ë¥•: ' + error.message);
                }
            };

            // ‰øùÂ≠òÊñ∞ÈÖçÁΩÆ
            const saveConfig = async () => {
                if (!adminToken) {
                    setMessage('ËØ∑ÂÖàËæìÂÖ•ÁÆ°ÁêÜÂëòÂè£‰ª§');
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch('/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-admin-token': adminToken
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        setMessage(`Êñ∞ÁâàÊú¨Â∑≤‰øùÂ≠ò: V${result.version} (ID: ${result.id})`);
                        loadHistory(); // Âà∑Êñ∞ÂéÜÂè≤ÂàóË°®
                    } else {
                        const errorText = await response.text();
                        setMessage('‰øùÂ≠òÂ§±Ë¥•: ' + errorText);
                    }
                } catch (error) {
                    setMessage('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            // ÂèëÂ∏ÉÈÖçÁΩÆ
            const publishConfig = async (configId) => {
                if (!adminToken) {
                    setMessage('ËØ∑ÂÖàËæìÂÖ•ÁÆ°ÁêÜÂëòÂè£‰ª§');
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(`/config/${configId}/publish`, {
                        method: 'POST',
                        headers: {
                            'x-admin-token': adminToken
                        }
                    });

                    if (response.ok) {
                        setMessage('ÈÖçÁΩÆÂèëÂ∏ÉÊàêÂäüÔºÅ');
                        loadCurrentConfig(); // Âà∑Êñ∞ÂΩìÂâçÈÖçÁΩÆ
                        loadHistory(); // Âà∑Êñ∞ÂéÜÂè≤ÂàóË°®
                    } else {
                        const errorText = await response.text();
                        setMessage('ÂèëÂ∏ÉÂ§±Ë¥•: ' + errorText);
                    }
                } catch (error) {
                    setMessage('ÂèëÂ∏ÉÂ§±Ë¥•: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            // ÂèëÈÄÅËÅäÂ§©Ê∂àÊÅØ
            const sendChatMessage = async () => {
                if (!chatInput.trim()) return;
                
                const userMessage = chatInput.trim();
                setChatInput('');
                setChatLoading(true);
                
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
                setChatMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                
                try {
                    const chatConfig = testMode ? formData : null;
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            ...(chatConfig && {
                                model: chatConfig.model,
                                temperature: chatConfig.temperature,
                                max_tokens: chatConfig.max_tokens,
                                system_prompt: chatConfig.system_prompt
                            })
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        setChatMessages(prev => [...prev, { 
                            role: 'assistant', 
                            content: result.response,
                            config: result.config_used
                        }]);
                    } else {
                        const errorText = await response.text();
                        setChatMessages(prev => [...prev, { 
                            role: 'error', 
                            content: 'ÂèëÈÄÅÂ§±Ë¥•: ' + errorText
                        }]);
                    }
                } catch (error) {
                    setChatMessages(prev => [...prev, { 
                        role: 'error', 
                        content: 'ÂèëÈÄÅÂ§±Ë¥•: ' + error.message
                    }]);
                } finally {
                    setChatLoading(false);
                }
            };

            // Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
            const clearChat = () => {
                setChatMessages([]);
            };

            // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
            useEffect(() => {
                loadCurrentConfig();
                loadHistory();
            }, []);

            return (
                <div className="container">
                    <h1>ü§ñ AIÊ®°ÂûãÈÖçÁΩÆÁÆ°ÁêÜ</h1>

                    {/* ÁÆ°ÁêÜÂëòÂè£‰ª§ */}
                    <div className="section token">
                        <h3>ÁÆ°ÁêÜÂëòÂè£‰ª§</h3>
                        <input
                            type="password"
                            value={adminToken}
                            onChange={(e) => setAdminToken(e.target.value)}
                            placeholder="ËØ∑ËæìÂÖ• x-admin-token"
                        />
                        <small>‰øùÂ≠ò„ÄÅÂèëÂ∏ÉÁ≠âÊìç‰Ωú‰ºöÂú®ËØ∑Ê±ÇÂ§¥‰∏≠ÈôÑÂ∏¶ x-admin-token„ÄÇ</small>
                    </div>

                    {/* ÂΩìÂâçÈÖçÁΩÆÊòæÁ§∫ */}
                    <div className="section current-config">
                        <h3>ÂΩìÂâçÁîüÊïàÈÖçÁΩÆ</h3>
                        {currentConfig ? (
                            <div>
                                <div className="config-item">
                                    <span className="config-label">Ê®°Âûã:</span>
                                    <span className="config-value">{currentConfig.model}</span>
                                </div>
                                <div className="config-item">
                                    <span className="config-label">Ê∏©Â∫¶:</span>
                                    <span className="config-value">{currentConfig.temperature}</span>
                                </div>
                                <div className="config-item">
                                    <span className="config-label">ÊúÄÂ§ßÈïøÂ∫¶:</span>
                                    <span className="config-value">{currentConfig.max_tokens}</span>
                                </div>
                                <div className="config-item">
                                    <span className="config-label">Á≥ªÁªüÊèêÁ§∫:</span>
                                    <span className="config-value">{currentConfig.system_prompt || 'Êó†'}</span>
                                </div>
                                <div className="config-item">
                                    <span className="config-label">ÊúÄÂêéÊõ¥Êñ∞:</span>
                                    <span className="config-value">
                                        {new Date(currentConfig.created_at).toLocaleString('zh-CN')}
                                    </span>
                                </div>
                            </div>
                        ) : (
                            <p className="muted">ÂΩìÂâçÊ≤°ÊúâÁîüÊïàÈÖçÁΩÆÔºåÁ≥ªÁªü‰ºö‰ΩøÁî®ÈªòËÆ§ÂèÇÊï∞„ÄÇ</p>
                        )}
                    </div>

                    {/* ÈÖçÁΩÆË°®Âçï */}
                    <div className="section">
                        <h3>Êñ∞Âª∫ÈÖçÁΩÆÁâàÊú¨</h3>
                        
                        <div className="form-group">
                            <label>AIÊ®°Âûã:</label>
                            <select
                                value={formData.model}
                                onChange={(e) => setFormData({...formData, model: e.target.value})}
                            >
                                {availableModels.map(model => (
                                    <option key={model.id} value={model.id}>
                                        {model.name} ({model.provider})
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="form-group">
                            <label>ÂàõÈÄ†ÊÄß (Temperature): {formData.temperature}</label>
                            <input
                                type="range"
                                min="0"
                                max="1"
                                step="0.05"
                                value={formData.temperature}
                                onChange={(e) => setFormData({...formData, temperature: parseFloat(e.target.value)})}
                            />
                        </div>

                        <div className="form-group">
                            <label>ÊúÄÂ§ßÂõûÂ§çÈïøÂ∫¶:</label>
                            <input
                                type="number"
                                min="100"
                                max="32768"
                                value={formData.max_tokens}
                                onChange={(e) => setFormData({...formData, max_tokens: parseInt(e.target.value)})}
                            />
                        </div>

                        <div className="form-group">
                            <label>Á≥ªÁªüÊèêÁ§∫ËØç (ÂèØÈÄâ):</label>
                            <textarea
                                value={formData.system_prompt}
                                onChange={(e) => setFormData({...formData, system_prompt: e.target.value})}
                                placeholder="‰æãÂ¶Ç: ‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÁºñÁ®ãÂä©Êâã..."
                            />
                        </div>

                        <button
                            onClick={saveConfig}
                            disabled={loading}
                        >
                            {loading ? '‰øùÂ≠ò‰∏≠...' : 'üíæ ‰øùÂ≠òÊñ∞ÁâàÊú¨'}
                        </button>
                    </div>

                    {/* ÂØπËØùÊµãËØïÂå∫Âüü */}
                    <div className="section">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3>üí¨ ÂØπËØùÊµãËØï</h3>
                            <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '5px', margin: 0 }}>
                                    <input
                                        type="checkbox"
                                        checked={testMode}
                                        onChange={(e) => setTestMode(e.target.checked)}
                                    />
                                    ‰ΩøÁî®‰∏äÊñπÊµãËØïÂèÇÊï∞
                                </label>
                                <button 
                                    onClick={clearChat}
                                    style={{ 
                                        background: '#6b7280', 
                                        padding: '5px 10px', 
                                        fontSize: '12px',
                                        minWidth: 'auto'
                                    }}
                                >
                                    Ê∏ÖÁ©∫ÂØπËØù
                                </button>
                            </div>
                        </div>
                        
                        {/* ËÅäÂ§©ËÆ∞ÂΩï */}
                        <div style={{ 
                            background: '#f9fafb',
                            border: '1px solid #e5e7eb',
                            borderRadius: '8px',
                            height: '400px',
                            overflowY: 'auto',
                            padding: '15px',
                            marginBottom: '15px'
                        }}>
                            {chatMessages.length === 0 ? (
                                <div style={{ 
                                    textAlign: 'center', 
                                    color: '#9ca3af', 
                                    marginTop: '150px' 
                                }}>
                                    ÂºÄÂßã‰∏éAIÂØπËØùÊù•ÊµãËØïÈÖçÁΩÆÊïàÊûú...
                                </div>
                            ) : (
                                chatMessages.map((msg, index) => (
                                    <div key={index} style={{ marginBottom: '15px' }}>
                                        {msg.role === 'user' && (
                                            <div style={{ textAlign: 'right' }}>
                                                <div style={{
                                                    display: 'inline-block',
                                                    background: '#2563eb',
                                                    color: 'white',
                                                    padding: '10px 15px',
                                                    borderRadius: '18px',
                                                    maxWidth: '70%',
                                                    textAlign: 'left'
                                                }}>
                                                    {msg.content}
                                                </div>
                                            </div>
                                        )}
                                        {msg.role === 'assistant' && (
                                            <div>
                                                <div style={{
                                                    display: 'inline-block',
                                                    background: 'white',
                                                    border: '1px solid #e5e7eb',
                                                    padding: '10px 15px',
                                                    borderRadius: '18px',
                                                    maxWidth: '70%'
                                                }}>
                                                    {msg.content}
                                                </div>
                                                {msg.config && (
                                                    <div style={{ 
                                                        fontSize: '11px', 
                                                        color: '#6b7280', 
                                                        marginTop: '5px',
                                                        marginLeft: '15px'
                                                    }}>
                                                        {msg.config.model} | T:{msg.config.temperature} | Max:{msg.config.max_tokens}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        {msg.role === 'error' && (
                                            <div style={{
                                                background: '#fee2e2',
                                                color: '#991b1b',
                                                padding: '10px 15px',
                                                borderRadius: '8px',
                                                border: '1px solid #fecaca'
                                            }}>
                                                ‚ùå {msg.content}
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                            {chatLoading && (
                                <div style={{ textAlign: 'left' }}>
                                    <div style={{
                                        display: 'inline-block',
                                        background: 'white',
                                        border: '1px solid #e5e7eb',
                                        padding: '10px 15px',
                                        borderRadius: '18px',
                                        color: '#6b7280'
                                    }}>
                                        AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* ËæìÂÖ•Âå∫Âüü */}
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <input
                                type="text"
                                value={chatInput}
                                onChange={(e) => setChatInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && !chatLoading && sendChatMessage()}
                                placeholder="ËæìÂÖ•Ê∂àÊÅØ‰∏éAIÂØπËØù..."
                                style={{ flex: 1 }}
                                disabled={chatLoading}
                            />
                            <button
                                onClick={sendChatMessage}
                                disabled={chatLoading || !chatInput.trim()}
                                style={{ minWidth: '80px' }}
                            >
                                {chatLoading ? 'ÂèëÈÄÅ‰∏≠...' : 'ÂèëÈÄÅ'}
                            </button>
                        </div>
                        
                        <div style={{ fontSize: '12px', color: '#6b7280', marginTop: '10px' }}>
                            üí° ÊèêÁ§∫ÔºöÂãæÈÄâ"‰ΩøÁî®‰∏äÊñπÊµãËØïÂèÇÊï∞"ÂèØ‰ª•ÂÆûÊó∂ÊµãËØï‰∏çÂêåÈÖçÁΩÆÁöÑÊïàÊûúÔºå‰∏çÂãæÈÄâÂàô‰ΩøÁî®ÂΩìÂâçÁîüÊïàÈÖçÁΩÆ
                        </div>
                    </div>

                    {/* ÂéÜÂè≤ÁâàÊú¨ */}
                    <div className="section history">
                        <h3>ÂéÜÂè≤ÁâàÊú¨</h3>
                        {history.length > 0 ? (
                            <div>
                                {history.map(item => (
                                    <div key={item.id} className={`history-item ${item.is_active ? 'active' : ''}`}>
                                        <div>
                                            <div className="history-title">
                                                ÁâàÊú¨ V{item.version} {item.is_active && '(ÂΩìÂâçÁîüÊïà)'}
                                            </div>
                                            <div className="history-meta">
                                                ÂàõÂª∫Êó∂Èó¥: {new Date(item.created_at).toLocaleString('zh-CN')}
                                            </div>
                                            <div className="history-detail">
                                                Ê®°Âûã: {item.model} | Ê∏©Â∫¶: {item.temperature} | ÈïøÂ∫¶: {item.max_tokens}
                                            </div>
                                        </div>
                                        <div className="history-actions">
                                            <button
                                                onClick={() => publishConfig(item.id)}
                                                disabled={item.is_active || loading}
                                                className={item.is_active ? 'active' : 'publish'}
                                            >
                                                {item.is_active ? 'ÂΩìÂâçÁîüÊïà' : 'ÂèëÂ∏É'}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p className="muted">ÊöÇÊó†ÂéÜÂè≤ÁâàÊú¨</p>
                        )}
                    </div>

                    {/* Áä∂ÊÄÅÊ∂àÊÅØ */}
                    {message && (
                        <div className={`status ${message.includes('ÊàêÂäü') ? 'success' : 'error'}`}>
                            {message}
                        </div>
                    )}
                </div>
            );
        };

        try {
            ReactDOM.render(<ModelConfigPage />, document.getElementById('root'));
        } catch (error) {
            console.error('ReactÊ∏≤ÊüìÈîôËØØ:', error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h2>È°µÈù¢Âä†ËΩΩÂ§±Ë¥•</h2>
                    <p>ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÂà∑Êñ∞È°µÈù¢ÈáçËØï</p>
                    <p style="color: red; font-size: 12px;">ÈîôËØØ‰ø°ÊÅØ: ${error.message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
